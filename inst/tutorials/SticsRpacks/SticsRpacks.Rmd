---
title: "Tutorial for SticsRpacks"
output: 
  learnr::tutorial:
    theme: cerulean
    ace_theme: pastel_on_dark
    anchor_sections: FALSE
    progressive: true
description: "A tutorial to learn SticsRpacks"
runtime: shiny_prerendered
params:
  gen_help: TRUE
  javastics: JavaSTICS-1.41-stics-9.2
  workspace_xml: JavaSTICS-1.41-stics-9.2/example
  workspace_txt: example
  use_default: TRUE
  work_dir: !r file.path(normalizePath(dirname(tempdir()), winslash = "/"), "SticsRpacks")
---

```{r setup, include=FALSE}
library(learnr)
library(SticsRPacks)
# library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
tutorial_options(exercise.lines = 5)
# gradethis::gradethis_setup()
```

```{r set_var, echo=FALSE, results='hide'}
# Add checking JavaStics path

work_dir <- params$work_dir
work_dir <- gsub(pattern = "\\\\", replacement="/", x=work_dir)

# Creating work_dir if needed
if (!dir.exists(work_dir)) dir.create(work_dir)

javastics <- file.path(work_dir, params$javastics, fsep ="/")

if (!dir.exists(javastics)) dir.create(javastics)

if(!any(grepl("JavaStics.exe",list.files(javastics)))) {
  zip_path <- file.path(work_dir,paste0(params$javastics,".zip"))
  system(paste0("curl -u stics_user:w10lptr6405 https://w3.avignon.inra.fr/forge/attachments/download/2402/",params$javastics,".zip --output ", zip_path))
  unzip(zip_path, exdir = javastics)
}

workspace_xml <- file.path(work_dir, params$workspace_xml, fsep ="/")
workspace_txt <- file.path(work_dir, params$workspace_txt, fsep ="/")
```

```{r, echo=FALSE, warning=FALSE}

# Generating html help files, one for each function
if(params$gen_help) {
  help_dir <- file.path(work_dir, "SticsRFiles_help")
  if (!dir.exists(help_dir)) dir.create(help_dir)
  SticsRFiles:::static_help(pkg = "SticsRFiles", 
                            overwrite = FALSE, 
                            out_dir = help_dir)
}

```

## Introduction

**Décrire ici en 2 mots ce que font les paquets**

Detailed documentation on the different packages can be found at:

* [https://sticsrpacks.github.io/SticsRFiles/]
* [https://sticsrpacks.github.io/SticsOnR/]
* [https://sticsrpacks.github.io/CroptimizR/]
* [https://sticsrpacks.github.io/CroPlotR/]

**Expliquer aussi comment trouver de l'aide sur les fonctions: ? + reference, ...**


## A foretaste of SticsRpacks 

### TP Stics


### A simple example

vignette CroptimizR ou encore plus simple (1 seul param) pour réduire le temps d’exécution …


## Finding names of STICS variables


## Exploring the content of Stics files 
 
### Get usm names

**Function** `get_usms_list` from the [SticsRFiles package](https://sticsrpacks.github.io/SticsRFiles/index.html)

```{r, results="asis"}
lines <- SticsRFiles:::get_from_help(file.path(help_dir,"get_usms_list.html"))
cat( paste( lines , collapse="\n" ) )
```

#### Exercises

* Get the list of USMs included in the Example workspace of the JavaStics distribution, which path is stored in workspace_xml.

```{r get_usms_list1, exercise=TRUE}
# Insert your R code here!
```

```{r get_usms_list1-hint-1}
# The list of USMs is included in the usms.xml file ...
```

```{r get_usms_list1-hint-2}
# Use file.path function to build full path to a file from directory names and filenames: file.path(path,filename) 
```

```{r get_usms_list1-solution}
get_usms_list(usm_path = file.path(workspace_xml, "usms.xml"))
```

<!-- ```{r get_usms_list1-check} -->
<!-- grade_result( -->
<!--   pass_if(~identical(.result, get_usms_list(usm_path = file.path(workspace_xml, "usms.xml")))) -->
<!-- ) -->
<!-- ``` -->

* Get the list of cover-crops USMs (their name starts with "cc_").

```{r get_usms_list2, exercise=TRUE}
# Insert your R code here!
```

```{r get_usms_list2-hint-1}
# The argument name is particularly useful in this case ...
```

```{r get_usms_list2-solution}
#SOLUTION:
get_usms_list(usm_path = file.path(workspace_xml, "usms.xml"), name = "cc_")
```

### Get information from STICS input files

**Function** `get_param_xml` from the [SticsRFiles package](https://sticsrpacks.github.io/SticsRFiles/index.html)

```{r, results="asis"}
lines <- SticsRFiles:::get_from_help(file.path(help_dir,"get_param_xml.html"))
cat( paste( lines , collapse="\n" ) )
```

#### Exercises

* Get the values of clay content after decarbonation (argi) for all soils defined in the Example workspace of the JavaStics distribution. Store the result of the function in a variable called result and print it.

```{r get_param_xml1, exercise=TRUE}
# Insert your R code here!
```

```{r get_param_xml1-hint-1}
# Soils are defined in the "sols.xml" file ...
```

```{r get_param_xml1-hint-2}
# Use print function to print a variable ...
```

```{r get_param_xml1-solution}
#SOLUTION:
result <- get_param_xml(file.path(workspace_xml,"sols.xml"), c("argi"))
print(result)
```

```{r get_param_xml2-setup}
result <- get_param_xml(file.path(workspace_xml,"sols.xml"), c("argi"))
```

* Plot an histogram of these values

```{r get_param_xml2, exercise=TRUE}
# Insert your R code here!
```

```{r get_param_xml2-hint-1}
# Use hist function to plot an histogram
```

```{r get_param_xml2-hint-2}
# result is a list: argi is stored in result$sols.xml$argi
```

```{r get_param_xml2-solution}
#SOLUTION:
hist(result$sols.xml$argi)
```

* Compute the Available Water Capacity of soil solmais in mm

```{r get_param_xml3, exercise=TRUE}
# Insert your R code here!
```

```{r get_param_xml3-hint-1}
# Equation of Available Water Capacity in mm from STICS inputs is: AWC=sum[(HCCF-HMINF)*epc*DAF/10]
```

```{r get_param_xml3-hint-2}
# Use select and value arguments of get_param_xml to extract information for a given soil
```

```{r get_param_xml3-solution}
# SOLUTION:
result <- get_param_xml(file.path(workspace_xml,"sols.xml"), c("HCCF","HMINF","epc","DAF"),select="sol",value="solmais")
sum((result$sols.xml$HCCF-result$sols.xml$HMINF)*result$sols.xml$epc*result$sols.xml$DAF/10)
```

<div class="note">
See also: 

* `get_param_txt` to get values from STICS text input files 
* `get_climate_txt` to STICS input weather file.
</div>


**ILLUSTRER get_climate_txt ? (calculer cumul de pluie entre 2 dates?)**



## Running simulations from R

**Function** `run_javaStics` from the [SticsOnR package](https://sticsrpacks.github.io/SticsOnR/index.html)

### Exercises

* Run all the USMs defined in the Example workspace of the JavaStics distribution. Path to JavaStics is stored in the javastics variable.

```{r run_javaStics1, exercise=TRUE}
# Insert your R code here!
```


```{r run_javaStics1-hint-1}
# No need to use the usms_list argument!
```

```{r run_javaStics1-solution}
# SOLUTION:
run_javastics(javastics_path=javastics,  workspace_path = workspace_xml)
```

* Run only the USMs banana and Turmeric.

```{r run_javaStics2, exercise=TRUE}
# Insert your R code here!
```


```{r run_javaStics2-hint-1}
# Use the usms_list argument!
```

```{r run_javaStics2-solution}
# SOLUTION:
run_javastics(javastics_path=javastics,  workspace_path = workspace_xml, usms_list = c("banana","Turmeric"))
```


**see also: gen_varmod ?**
 
 
 
## Exploring and Evaluating the Stics results
PATRICE

	get_sim
Récupérer tous les résultats simulés
Récupérer les résultats pour la variable XXX et les USMs XXX et XXX

	plot stics results
		Tracer les dynamiques des variables XXX et XXX indépendamment ou superposées
	
	get_obs
  (mettre une note sur l'utilisation de usms.xml ?)

	Evaluate
		dynamiques avec des obs
		scatter_plots basiques
		scatter_plots avec gestion des symboles : demander de mettre des symboles différents selon des groupes d’USMs
		stats et graphiques associés




## Advanced use
 
### Modifying Stics files
SAMUEL-REMI 

Leur faire trouver les noms de fonction dans le REFERENCE du site web ... 
 


### Generating Stics input Files
SAMUEL

Generate JavaStics Input files (XML format)

Generate Stics Input files (Text format)

Generate obs

### Running simulations from R using stics_wrapper
REMI

  
	stics_wrapper
		run sur un lot d’USMs et sélection des variables à renvoyer
		forçage de paramètre, y compris par USMs
		parallélisation

La difference avec runJavaStics
	
### Estimating parameters
REMI

estim_param
	méthode par défaut
	Afficher résultats produits et plots

plots avec CroPlotR : run du wrapper sur les résultats de l'optimisation puis plot sim-obs

### Succession culturales
REMI
 
	stics_wrapper
	CroPlotR : dynamique sur succession
estim_param

### Intercrop
SAMUEL

	
	get_daily_results
CroPlotR : plot + stats ?	
 
### Advanced parameter estimation 
REMI

plus avancé :
	contraintes inégalités
	paramètres par groupe (varietal / spécifique)
méthode bayesienne
transfo des sim et obs ???


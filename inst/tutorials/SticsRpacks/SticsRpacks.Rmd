---
title: "Tutorial for SticsRpacks"
output: 
  learnr::tutorial:
    theme: cerulean
    ace_theme: pastel_on_dark
    anchor_sections: FALSE
    progressive: true
description: "A tutorial to learn SticsRpacks"
runtime: shiny_prerendered
params:
  gen_help: TRUE
  javastics: JavaSTICS-1.41-stics-9.2
  workspace_xml: JavaSTICS-1.41-stics-9.2/example
  workspace_txt: example
  use_default: TRUE
  work_dir: !r file.path(normalizePath(dirname(tempdir()), winslash = "/"), "SticsRpacks")
---

```{r setup, include=FALSE}
library(learnr)
library(SticsRPacks)
# library(gradethis)
knitr::opts_chunk$set(echo = FALSE)
tutorial_options(exercise.lines = 5)
# gradethis::gradethis_setup()
```

```{r set_var, echo=FALSE, results='hide'}
# Add checking JavaStics path

work_dir <- params$work_dir
work_dir <- gsub(pattern = "\\\\", replacement="/", x=work_dir)

# Creating work_dir if needed
if (!dir.exists(work_dir)) dir.create(work_dir)

javastics <- file.path(work_dir, params$javastics, fsep ="/")

if (!dir.exists(javastics)) dir.create(javastics)

if(!any(grepl("JavaStics.exe",list.files(javastics)))) {
  zip_path <- file.path(work_dir,paste0(params$javastics,".zip"))
  system(paste0("curl -u stics_user:w10lptr6405 https://w3.avignon.inra.fr/forge/attachments/download/2402/",params$javastics,".zip --output ", zip_path))
  unzip(zip_path, exdir = javastics)
}

workspace_xml <- file.path(work_dir, params$workspace_xml, fsep ="/")
workspace_txt <- file.path(work_dir, params$workspace_txt, fsep ="/")
```

```{r, echo=FALSE, warning=FALSE}

# Generating html help files, one for each function
if(params$gen_help) {
  help_dir <- file.path(work_dir, "SticsRFiles_help")
  if (!dir.exists(help_dir)) dir.create(help_dir)
  SticsRFiles:::static_help(pkg = "SticsRFiles", 
                            overwrite = FALSE, 
                            out_dir = help_dir)
}

```

## Introduction

**Décrire ici en 2 mots ce que font les paquets**

Detailed documentation on the different packages can be found at:

* [https://sticsrpacks.github.io/SticsRFiles/]
* [https://sticsrpacks.github.io/SticsOnR/]
* [https://sticsrpacks.github.io/CroptimizR/]
* [https://sticsrpacks.github.io/CroPlotR/]


## A foretaste of SticsRpacks 

### TP Stics


### A simple example

vignette CroptimizR ou encore plus simple (1 seul param) pour réduire le temps d’exécution …



## Exploring the content of Stics files 
 
### Get usm names

`get_usms_list`

```{r, results="asis"}
lines <- SticsRFiles:::get_from_help(file.path(help_dir,"get_usms_list.html"))
cat( paste( lines , collapse="\n" ) )
```

#### Exercises

```{r get_usms_list1, exercise=TRUE}
# Get the list of USMs included in the JavaStics distribution Example directory (which path is stored in workspace_xml)
```

```{r get_usms_list1-solution}
get_usms_list(usm_path = file.path(workspace_xml, "usms.xml"))
```

<!-- ```{r get_usms_list1-check} -->
<!-- grade_result( -->
<!--   pass_if(~identical(.result, get_usms_list(usm_path = file.path(workspace_xml, "usms.xml")))) -->
<!-- ) -->
<!-- ``` -->

```{r get_usms_list2, exercise=TRUE}
# Get the list of cover-crops USMs (their name starts with "cc_")
```

```{r get_usms_list2-hint-1}
# The argument name is particularly useful in this case ...
```

```{r get_usms_list2-solution}
#SOLUTION:
get_usms_list(usm_path = file.path(workspace_xml, "usms.xml"), name = "cc_")
```



`get_param_xml`

**TO BE CONTINUED ...**
SAMUEL

 
		Récupérer les valeurs de XXX et XXX pour tout les sols
		Faire un plot des valeurs (histogramme ou argi vs Norg)
 
		Récupérer les valeurs de XX et XXX pour les sols XXX et XXX
 
get_param_txt()
Récupérer les valeurs de argi et Norg pour les sols des USMs ... (même question que get_param_xml)
		ou alors simplement expliquer qu’on peut le faire, mais sans faire d’exercice ?
 
 
## Running simulations from R
SAMUEL

	run_javaStics
		Run d’un sous-ensemble des USMs
 
	see also: gen_varmod
 
 
## Exploring and Evaluating the Stics results
PATRICE

	get_sim
Récupérer tous les résultats simulés
Récupérer les résultats pour la variable XXX et les USMs XXX et XXX

	plot stics results
		Tracer les dynamiques des variables XXX et XXX indépendamment ou superposées
	
	get_obs
  (mettre une note sur l'utilisation de usms.xml ?)

	Evaluate
		dynamiques avec des obs
		scatter_plots basiques
		scatter_plots avec gestion des symboles : demander de mettre des symboles différents selon des groupes d’USMs
		stats et graphiques associés




## Advanced use
 
### Modifying Stics files
SAMUEL-REMI 

Leur faire trouver les noms de fonction dans le REFERENCE du site web ... 
 


### Generating Stics input Files
SAMUEL

Generate JavaStics Input files (XML format)

Generate Stics Input files (Text format)

Generate obs

### Running simulations from R using stics_wrapper
REMI

  
	stics_wrapper
		run sur un lot d’USMs et sélection des variables à renvoyer
		forçage de paramètre, y compris par USMs
		parallélisation

La difference avec runJavaStics
	
### Estimating parameters
REMI

estim_param
	méthode par défaut
	Afficher résultats produits et plots

plots avec CroPlotR : run du wrapper sur les résultats de l'optimisation puis plot sim-obs

### Succession culturales
REMI
 
	stics_wrapper
	CroPlotR : dynamique sur succession
estim_param

### Intercrop
SAMUEL

	
	get_daily_results
CroPlotR : plot + stats ?	
 
### Advanced parameter estimation 
REMI

plus avancé :
	contraintes inégalités
	paramètres par groupe (varietal / spécifique)
méthode bayesienne
transfo des sim et obs ???

